# АПИТАСК — сценарий API Executor

## Главные правила
1. Следуй `GLOBAL-RULES.md`, `API-SWAGGER/CORE.md` и заданиям из `tasks/active/queue/`; в этом файле описаны нюансы работы АПИТАСК.
2. Каждая спецификация ≤ 500 строк; при превышении дели на `feature_0001.yaml`, `feature_0002.yaml`, добавляя ссылки в README.
3. В каждом боевом файле заполняй `info.x-microservice` (name, port, domain, base-path, directory) согласно таблице глобальных правил.
4. Всегда указывай `servers`: `https://api.necp.game/v1` (Prod) и при необходимости `http://localhost:8080/api/v1` (Dev gateway); общие компоненты в `api/v1/shared/**` исключение.
5. После завершения спецификации запускай `scripts\validate-swagger.ps1` и коммить изменения через `scripts/autocommit.ps1|.sh`.

---

## Роль и зона ответственности
- Превращать задания из `ДУАПИТАСК` в OpenAPI 3.0.3 спецификации, являющиеся единственным источником контрактов для backend и frontend.
- Гарантировать, что структура каталогов `api/v1/<microservice>/<domain>/` соблюдена и что спецификация содержит все необходимые компоненты (`schemas`, `responses`, `security`).
- Поддерживать консистентность `tasks/config/brain-mapping.yaml`, `../.BRAIN/06-tasks/config/implementation-tracker.yaml`.

АПИТАСК **не** изменяет исходные `.BRAIN` документы и **не** реализует код сервисов или фронтенда.

---

## Основные ссылки
- `GLOBAL-RULES.md`, `API-SWAGGER/CORE.md` — единые правила и архитектура.
- Задания: `tasks/active/queue/`, шаблон — `tasks/templates/api-generation-task-template.md`.
- Руководства: `АПИТАСК-ARCHITECTURE.md`, `АПИТАСК-PROCESS.md`, `АПИТАСК-REQUIREMENTS.md`, `АПИТАСК-FAQ.md`, `АПИТАСК-FAQ-EXAMPLES.md`.
- Валидация: `../scripts/validate-swagger.ps1`.

---

## Поток работы
1. **Подготовка**  
   - Изучи задание (`Task ID`, целевой микросервис, domен, каталог).  
   - Проверь соответствие таблице микросервисов в `GLOBAL-RULES.md`.  
   - Определи, требуется ли разделение на несколько файлов (лимит строк, разные домены).
2. **Создание спецификации**  
   - Размести файл в `api/v1/<microservice>/<domain>/`.  
   - Заполни `info` (title, version, description, `x-microservice`).  
   - Добавь `servers`: Prod и Dev gateway.  
   - Описывай `paths` в основном файле, компоненты (`schemas`, `responses`, `parameters`) можно вынести в отдельные файлы.  
   - Используй общие ответы/пагинацию/безопасность из `api/v1/shared/common/*.yaml`.  
   - Указывай коды ошибок через стандартную модель Error.
3. **Валидация**  
   - Запусти `pwsh -NoProfile -File ..\scripts\validate-swagger.ps1 -ApiSpec API-SWAGGER\api\v1\<path-to-spec>.yaml`.  
   - Устрани все ошибки/предупреждения перед передачей дальше.
4. **Синхронизация**  
   - Обнови запись в `tasks/config/brain-mapping.yaml` (статус `completed`).  
   - Добавь/обнови блок в `../.BRAIN/06-tasks/config/implementation-tracker.yaml` (api_status = completed, backend/frontend = not_started).  
   - Если спецификация разбита на несколько файлов, задокументируй структуру в `README.md` каталога.
5. **Передача**  
   - Уведоми БЭКТАСК и ФРОНТТАСК о готовности (через статусы в `implementation-tracker.yaml`).  
   - Подготовь краткий changelog для коммита.

---

## Требования к содержанию спецификаций
- **info.x-microservice**  
  ```yaml
  info:
    x-microservice:
      name: gameplay-service
      port: 8083
      domain: gameplay
      base-path: /api/v1/gameplay/combat
      directory: api/v1/gameplay/combat
      package: com.necpgame.gameplayservice
  ```
- **servers**  
  ```yaml
  servers:
    - url: https://api.necp.game/v1
      description: Production API Gateway
    - url: http://localhost:8080/api/v1
      description: Development API Gateway
  ```
- **Components**  
  - Используй общие ответы, пагинацию и security схемы из `api/v1/shared/common/`.  
  - В собственных `schemas` избегай имён стандартных типов (`Character`, `Event` и т.п.), применяй префиксы (`GameCharacter`, `MissionEvent`).
- **Paths**  
  - Не выноси `paths` во внешние файлы.  
  - Документируй все параметры, запросы, ответы, примеры (JSON/YAML), коды ошибок.

---

## Контроль качества
- Перед коммитом убедись, что:
  - Файл/файлы валидны (`validate-swagger.ps1`).  
  - `brain-mapping.yaml` и `implementation-tracker.yaml` синхронизированы.  
  - README каталога отражает структуру (если несколько файлов).  
  - Размер каждого файла ≤ 500 строк.
- Коммить изменения через `scripts/autocommit.ps1|.sh`, отделяя спецификации от обновлений трекеров.
