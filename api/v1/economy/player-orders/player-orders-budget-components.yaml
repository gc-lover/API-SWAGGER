components:
  parameters:
    OrderId:
      name: orderId
      in: path
      required: true
      description: Уникальный идентификатор заказа игрока.
      schema:
        type: string
        format: uuid
    JobId:
      name: jobId
      in: path
      required: true
      description: Идентификатор задачи асинхронного расчёта бюджета.
      schema:
        type: string
        format: uuid
    TemplateCode:
      name: template
      in: query
      required: false
      description: Код шаблона заказа (combat, hacker, economy, social, exploration).
      schema:
        $ref: '#/components/schemas/OrderTemplateCode'
    DistrictCode:
      name: district
      in: query
      required: false
      description: Код района, в котором исполняется заказ.
      schema:
        type: string
        minLength: 2
        maxLength: 32
    FactionCode:
      name: faction
      in: query
      required: false
      description: Код фракции, влияющей на рыночные коэффициенты.
      schema:
        type: string
        minLength: 2
        maxLength: 32
    Interval:
      name: interval
      in: query
      required: false
      description: Интервал агрегации значений рыночного индекса.
      schema:
        $ref: '#/components/schemas/MarketIndexInterval'
    Currency:
      name: currency
      in: query
      required: false
      description: Код валюты ISO 4217, в которой требуется представить расчёт.
      schema:
        type: string
        pattern: '^[A-Z]{3}$'
  schemas:
    OrderTemplateCode:
      type: string
      description: Код типового шаблона заказа.
      enum:
        - combat
        - hacker
        - economy
        - social
        - exploration
    RiskLevel:
      type: string
      description: Уровень риска, полученный из world-service.
      enum:
        - low
        - medium
        - high
        - severe
        - extreme
    InsuranceTierCode:
      type: string
      description: Код страхового плана, доступного заказчику.
      enum:
        - basic
        - extended
        - premium
    BudgetWarningCode:
      type: string
      description: Код предупреждения расчёта бюджета.
      enum:
        - BUDGET_OVERESTIMATED
        - BUDGET_UNDERESTIMATED
        - MARKET_SPIKE
        - MARKET_DROP
        - RISK_HIGH
        - ESCROW_TOO_LOW
        - COMMISSION_TOO_LOW
    MarketIndexInterval:
      type: string
      description: Интервал агрегации значений рыночного индекса.
      enum:
        - 15m
        - 1h
        - 6h
        - 24h
    PlayerOrderBudgetEstimateRequest:
      type: object
      required:
        - complexityScore
        - riskModifier
        - marketIndex
        - timeModifier
        - templateCode
        - districtCode
        - preferredCurrency
      properties:
        complexityScore:
          type: number
          format: float
          minimum: 0
          description: Суммарный ComplexityScore заказа.
          example: 145.5
        riskModifier:
          type: number
          format: float
          minimum: 0.8
          maximum: 1.5
          description: Коэффициент риска `RiskModifier`.
          example: 1.2
        marketIndex:
          type: number
          format: float
          minimum: 0
          description: Текущее значение `MarketIndex`.
          example: 1.08
        timeModifier:
          type: number
          format: float
          minimum: 1.0
          maximum: 1.3
          description: Коэффициент времени `TimeModifier`.
          example: 1.1
        templateCode:
          $ref: '#/components/schemas/OrderTemplateCode'
        districtCode:
          type: string
          minLength: 2
          maxLength: 32
          description: Код района, в котором планируется заказ.
          example: NC-14
        factionCode:
          type: string
          minLength: 2
          maxLength: 32
          description: Фракция, влияющая на коэффициенты.
          example: SPECTER
        riskLevel:
          $ref: '#/components/schemas/RiskLevel'
        preferredCurrency:
          type: string
          pattern: '^[A-Z]{3}$'
          description: Код валюты, выбранной заказчиком.
          example: NCD
        guaranteeTier:
          $ref: '#/components/schemas/InsuranceTierCode'
        isCorporate:
          type: boolean
          description: Флаг корпоративного заказа.
          default: false
        manualAdjustment:
          type: boolean
          description: Признак ручной корректировки параметров.
          default: false
        adjustmentReason:
          type: string
          description: Причина ручной корректировки (обязательно при `manualAdjustment = true`).
          minLength: 3
          maxLength: 512
        bonuses:
          type: array
          description: Дополнительные бонусы бюджета.
          items:
            $ref: '#/components/schemas/BudgetModifier'
        penalties:
          type: array
          description: Штрафы, влияющие на бюджет.
          items:
            $ref: '#/components/schemas/BudgetModifier'
    BudgetModifier:
      type: object
      required:
        - code
        - value
      properties:
        code:
          type: string
          minLength: 2
          maxLength: 64
        description:
          type: string
          minLength: 2
          maxLength: 256
        value:
          type: number
          format: float
          description: Величина модификатора (процент или множитель).
        type:
          type: string
          enum:
            - additive
            - multiplicative
    BudgetWarning:
      type: object
      required:
        - code
        - severity
        - messageKey
      properties:
        code:
          $ref: '#/components/schemas/BudgetWarningCode'
        severity:
          type: string
          enum:
            - info
            - warning
            - error
        messageKey:
          type: string
          minLength: 3
          maxLength: 128
        defaultMessage:
          type: string
          minLength: 3
          maxLength: 512
        suggestedAction:
          type: string
          minLength: 2
          maxLength: 256
        threshold:
          type: number
          format: float
          description: Пороговое значение, вызвавшее предупреждение.
    CalculationBreakdown:
      type: object
      required:
        - baseRewardFormula
        - factors
      properties:
        baseRewardFormula:
          type: string
          example: BaseReward = ComplexityScore * RiskModifier * MarketIndex * TimeModifier
        factors:
          type: object
          required:
            - complexityScore
            - riskModifier
            - marketIndex
            - timeModifier
          properties:
            complexityScore:
              type: number
              format: float
            riskModifier:
              type: number
              format: float
            marketIndex:
              type: number
              format: float
            timeModifier:
              type: number
              format: float
            districtAdjustment:
              type: number
              format: float
            factionAdjustment:
              type: number
              format: float
            manualAdjustment:
              type: number
              format: float
        auditTrail:
          type: array
          items:
            type: object
            required:
              - timestamp
              - action
            properties:
              timestamp:
                type: string
                format: date-time
              action:
                type: string
              valueBefore:
                type: number
                format: float
              valueAfter:
                type: number
                format: float
    PlayerOrderBudgetEstimateResponse:
      type: object
      required:
        - baseReward
        - escrow
        - commission
        - insuranceFee
        - recommendedBudgetRange
        - calculationBreakdown
        - warnings
      properties:
        baseReward:
          type: number
          format: float
          minimum: 0
        escrow:
          type: number
          format: float
          minimum: 0
        commission:
          type: number
          format: float
          minimum: 0
        commissionRate:
          type: number
          format: float
          minimum: 0.05
          maximum: 0.12
        insuranceFee:
          type: number
          format: float
          minimum: 0
        insuranceTier:
          $ref: '#/components/schemas/InsuranceTierCode'
        recommendedBudgetRange:
          type: object
          required:
            - min
            - max
          properties:
            min:
              type: number
              format: float
            max:
              type: number
              format: float
        median:
          type: number
          format: float
        deviationPercent:
          type: number
          format: float
        currency:
          type: string
          pattern: '^[A-Z]{3}$'
        warnings:
          type: array
          items:
            $ref: '#/components/schemas/BudgetWarning'
        calculationBreakdown:
          $ref: '#/components/schemas/CalculationBreakdown'
        nextRefreshAt:
          type: string
          format: date-time
        jobId:
          type: string
          format: uuid
    BudgetComparisonRequest:
      type: object
      required:
        - proposedBudget
        - templateCode
        - districtCode
      properties:
        proposedBudget:
          type: number
          format: float
          minimum: 0
        templateCode:
          $ref: '#/components/schemas/OrderTemplateCode'
        districtCode:
          type: string
          minLength: 2
          maxLength: 32
        factionCode:
          type: string
          minLength: 2
          maxLength: 32
        currency:
          type: string
          pattern: '^[A-Z]{3}$'
    BudgetComparisonResult:
      type: object
      required:
        - proposedBudget
        - recommendedBudget
        - medianBudget
        - deviationPercent
        - warnings
      properties:
        proposedBudget:
          type: number
          format: float
        recommendedBudget:
          type: number
          format: float
        medianBudget:
          type: number
          format: float
        deviationPercent:
          type: number
          format: float
        percentileRange:
          type: object
          properties:
            p25:
              type: number
              format: float
            p75:
              type: number
              format: float
        warnings:
          type: array
          items:
            $ref: '#/components/schemas/BudgetWarning'
    InsuranceTier:
      type: object
      required:
        - id
        - name
        - coverage
        - commissionRate
        - escrowMultiplier
      properties:
        id:
          $ref: '#/components/schemas/InsuranceTierCode'
        name:
          type: string
          minLength: 3
          maxLength: 64
        description:
          type: string
          minLength: 3
          maxLength: 256
        coverage:
          type: number
          format: float
          minimum: 0
        commissionRate:
          type: number
          format: float
          minimum: 0.05
          maximum: 0.12
        escrowMultiplier:
          type: number
          format: float
          minimum: 0.1
          maximum: 0.3
        bonusReputation:
          type: number
          format: float
        conditions:
          type: array
          items:
            type: string
    MarketIndexSnapshot:
      type: object
      required:
        - timestamp
        - value
        - volatility
      properties:
        timestamp:
          type: string
          format: date-time
        value:
          type: number
          format: float
        volatility:
          type: number
          format: float
        source:
          type: string
          minLength: 2
          maxLength: 64
    MarketIndexHistory:
      type: object
      required:
        - interval
        - snapshots
      properties:
        interval:
          $ref: '#/components/schemas/MarketIndexInterval'
        snapshots:
          type: array
          items:
            $ref: '#/components/schemas/MarketIndexSnapshot'
        nextRefreshAt:
          type: string
          format: date-time
    EscrowLockRequest:
      type: object
      required:
        - ownerId
        - escrowAmount
        - insuranceTier
      properties:
        ownerId:
          type: string
          format: uuid
        escrowAmount:
          type: number
          format: float
          minimum: 0
        insuranceTier:
          $ref: '#/components/schemas/InsuranceTierCode'
        holdDurationMinutes:
          type: integer
          minimum: 5
          maximum: 1440
        currency:
          type: string
          pattern: '^[A-Z]{3}$'
        auditTraceId:
          type: string
          format: uuid
    EscrowLockResponse:
      type: object
      required:
        - orderId
        - escrowAmount
        - status
        - lockExpiresAt
      properties:
        orderId:
          type: string
          format: uuid
        escrowAmount:
          type: number
          format: float
        status:
          type: string
          enum:
            - locked
            - pending
            - released
        insuranceTier:
          $ref: '#/components/schemas/InsuranceTierCode'
        lockExpiresAt:
          type: string
          format: date-time
        warnings:
          type: array
          items:
            $ref: '#/components/schemas/BudgetWarning'
        kafkaEventId:
          type: string
          format: uuid
    EscrowReleaseResponse:
      type: object
      required:
        - orderId
        - status
      properties:
        orderId:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - released
            - pending
        releasedAt:
          type: string
          format: date-time
    BudgetEstimateJob:
      type: object
      required:
        - jobId
        - status
        - submittedAt
      properties:
        jobId:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - queued
            - running
            - completed
            - failed
        submittedAt:
          type: string
          format: date-time
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
        progress:
          type: number
          format: float
          minimum: 0
          maximum: 1
        result:
          $ref: '#/components/schemas/PlayerOrderBudgetEstimateResponse'
        errors:
          type: array
          items:
            type: string

